//! Application state management for HyperReview
//!
//! Provides centralized AppState following Constitution IV requirements.

use gpui::*;
use std::sync::Arc;

use crate::config::Config;
use crate::services::{DbService, GitService};

/// Central application state
///
/// Following Constitution IV: Application state MUST be centralized in AppState struct
pub struct AppState {
    /// Application configuration
    pub config: Config,

    /// Database service (initialized lazily)
    pub db: Option<Arc<DbService>>,

    /// Git service
    pub git: Arc<GitService>,

    /// Current view state
    pub current_view: ViewState,

    /// Network availability
    pub is_online: bool,
}

/// Current view state
#[derive(Debug, Clone, PartialEq)]
pub enum ViewState {
    /// Authentication view
    Auth,
    /// PR inbox view
    Inbox,
    /// PR review/diff view
    Review { pr_id: String },
}

impl AppState {
    /// Create new application state
    pub fn new(_cx: &mut AppContext) -> Arc<Self> {
        let config = Config::default();
        let git = Arc::new(GitService::new());

        Arc::new(Self {
            config,
            db: None,
            git,
            current_view: ViewState::Auth,
            is_online: true,
        })
    }

    /// Initialize database connection
    pub async fn init_db(&mut self) -> crate::Result<()> {
        let db = DbService::new(&self.config.database_path).await?;
        self.db = Some(Arc::new(db));
        Ok(())
    }
}
