//! Git service for HyperReview
//!
//! git2-rs operations following Constitution I (Performance-First) requirements.

use git2::{Repository, Diff, DiffOptions};
use std::path::Path;

use crate::error::{Error, Result};

/// Git service for repository operations
pub struct GitService {
    // Service is stateless, repositories are opened per-operation
}

impl GitService {
    /// Create new git service
    pub fn new() -> Self {
        Self {}
    }

    /// Open a local git repository
    pub fn open_repository(&self, path: &Path) -> Result<Repository> {
        Repository::open(path).map_err(Error::from)
    }

    /// Compute diff between two commits
    pub fn compute_diff(
        &self,
        repo: &Repository,
        base_sha: &str,
        head_sha: &str,
    ) -> Result<Diff<'_>> {
        let base_oid = git2::Oid::from_str(base_sha)
            .map_err(|e| Error::InvalidId(format!("Invalid base SHA: {}", e)))?;
        let head_oid = git2::Oid::from_str(head_sha)
            .map_err(|e| Error::InvalidId(format!("Invalid head SHA: {}", e)))?;

        let base_commit = repo.find_commit(base_oid)?;
        let head_commit = repo.find_commit(head_oid)?;

        let base_tree = base_commit.tree()?;
        let head_tree = head_commit.tree()?;

        let mut opts = DiffOptions::new();
        opts.context_lines(3);

        let diff = repo.diff_tree_to_tree(Some(&base_tree), Some(&head_tree), Some(&mut opts))?;

        Ok(diff)
    }
}

impl Default for GitService {
    fn default() -> Self {
        Self::new()
    }
}
